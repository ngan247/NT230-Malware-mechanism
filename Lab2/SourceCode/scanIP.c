#include <stdio.h>
#include <string.h>
#include <netdb.h>
#include <netinet/in.h>

char ipCandidate[11];
char *targetIP;

void getCurrentAddress(){
    strcpy(ipCandidate, "");

    FILE *fp;
    char path[1035];
    /* Open the command for reading. */
    fp = popen("hostname -I", "r");
    
    /* Read the output a line at a time - output it. */
    while (fgets(path, sizeof(path), fp) != NULL) {
        strcat(ipCandidate, path);
    }

    // close 
    pclose(fp);
}

int main(int argc, char *argv[]){
    char converted;
    int i = 0;
    int x, y, z, flag1, flag2;
    
    int ss;
    struct sockaddr_in candidate;
    struct hostent *candidateHost;

    getCurrentAddress();
    printf("My IP address is: %s", ipCandidate);

    flag1 = ipCandidate[9];
    flag2 = ipCandidate[10];

    /*Get last byte of IP*/
    //last byte has 1 number
    if (flag1 == 32)
    {
        ipCandidate[9] = 0;
        ipCandidate[10] = 0;
        i = ipCandidate[8] - 48; //get interger value
    }
    //last byte has 2 numbers
    else if (flag2 == 32)
    {
        ipCandidate[10] = 0;
        i = (ipCandidate[8] - 48) * 10 + (ipCandidate[9] - 48); //get interger value
    }
    //last byte has 3 numbers
    else
    {
        i = (ipCandidate[8] - 48) * 100 + (ipCandidate[9] - 48) * 10 + (ipCandidate[10] - 48); //get interger value
    }
    
    i = i + 1; // scan ip kế tiếp
    for (i; i < 255; i++)
    {
        if (i < 10)
        {
            converted = i +'0';
            ipCandidate[8] = converted;
        }
        else if (i < 100)  
        {
            y = i % 10;
            converted = y + '0';
            ipCandidate[9] = converted;
            x = i - y;
            x = x / 10;
            converted = x + '0';
            ipCandidate[8] = converted;
        }
        else
        {
            z = i % 100;
            z = z % 10;
            converted = z + '0';
            ipCandidate[10] = converted;
            z = i - z;
            z = i / 10;
            y = z % 10;
            converted = y + '0';
            ipCandidate[9] = converted;
            x = z - y;
            x = x / 10;
            converted = x + '0';
            ipCandidate[8] = converted;
        }

        targetIP = ipCandidate;

        /*Check connection*/
        //getting hostname
        candidateHost=gethostbyname(targetIP);

        // creating socket...
        ss = socket(AF_INET, SOCK_STREAM, 0);
        if (ss < 0)
        {       
            fprintf(stderr, "Error: Socket\n");
            return;
        }
         //state Protocolfamily , then converting the hostname or IP address, and getting  port number
        candidate.sin_family = AF_INET;
        candidate.sin_addr = *((struct in_addr *)candidateHost->h_addr);
        candidate.sin_port = htons(5000);
        
        //check connecting on port 5000
        if (connect(ss, (struct sockaddr *)&candidate, sizeof(candidate))==-1)
        {
            close(ss);
            fprintf(stderr, "Error: connect to %s\n", targetIP);
        }
        else
        {
            close(ss);
            fprintf(stderr, "Connecting to %s 5000\n", targetIP);
            return;
        }
    }
    printf("Finish scanning\n");
}